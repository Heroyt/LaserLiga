# Heroyt's PHP Framework

**Author:** Tom√°≈° Voj√≠k <[vojik@wboy.cz](mailto:vojik@wboy.cz)>

**Web:** [laserliga.cz](https://laserliga.cz)

## Directory structure

- **assets** - frontend files go here
	- **scss** - all css files
	- **js** - all js files
- **config** - Configuration files
- **docs** - generated documentation - **html**
- **include** - core PHP files
- **languages** - translation files (gettext)
- **logs** - log files
- **private** - Hidden configuration files (db connection)
- **routes** - Route definitions
- **src** - main app source files: `\App` namespace
	- **Controllers** - Defined controllers
	- **Core** - App\Core namespace
	- **Exceptions** - Custom exceptions
	- **Models** - Defined models
	- **Logging** - Logger
	- **Tools** - Other helper classes
- **temp** - temporary files generated by the app
- **templates** - Latte templates
- **tests** - Unit tests
- **vendor** - libraries

## Code conventions

- **PHP version** - 8.0^
- **Charset** - UTF-8
- **Line break** - Unix
- **Indent** - Tab
- **Tab size** - 4
- **Variable naming scheme** - camelCase
- **Constant naming scheme** - UPPERCASE_SNAKE_CASE
- **Function naming scheme** - camelCase
- **Function / method declaration**
    ```php
    function functionName(...$arg) {
      // Code
    }
    ```
- **PHP array** - `[...]`

### Git conventions

#### Commit message guide:

See: [Gitmoji](https://gitmoji.carloscuesta.me)

- ‚¨ÜÔ∏è - Update dependencies
- üé® - Formatting update
- ‚ö°Ô∏è - Performance update
- üî• - Code or file deletion
- üêõ - Bugfix
- üöÄ - Deploy next version
- ‚úÖ - Testing
- üíÑ - Style and visual update
- ‚ôªÔ∏è - Refactor code
- üìÑ - Documentation or license update

## Used libraries

All libraries are installed using [**Composer**](https://getcomposer.org).

- [**Dibi**](https://dibiphp.com) - database connection library
- [**Nette**](https://nette.org) - Utils, Caching, Safe-stream, Mail
- [**Latte**](https://latte.nette.org) - Templating
- [**Tracy**](https://tracy.nette.org) - Debugging and logs
- [**PHPUnit**](https://phpunit.readthedocs.io/en/9.5/) - Unit testing PHP
- [**Tournament generator**](https://github.com/Heroyt/tournament-generator)

### Front end libraries

- [**Webpack**](https://webpack.js.org)
- [**Bootstrap**](https://getbootstrap.com)
- [**Axios**](https://axios-http.com) - AJAX library
- [**FlatPickr**](https://flatpickr.js.org) - Date (and time) picker

## Installation

First, you need to set up the app's config file.

Copy the `/private/config_dummy.ini` file to `/private/config.ini` and change the necessary DB connection configuration.

Then, install the application by calling:

```shell
$ composer install-app
```

This will install all dependencies, build webpack assets (css and js), create all DB tables and seed it with starting
data.

Lastly, you can start the PHP server with:

```shell
$ composer serve
```

*(You don't have to start the server if you have Apache setup already)*

## Tools

### Generate docs

Docs are written as phpdoc / doxygen style comments and generated using [**Doxygen**](https://www.doxygen.nl).

```shell script
$ doxygen
```

```shell script
$ composer docs
```

### Other

```shell
$ composer build
```

Installs composer dependencies, installs npm dependencies, builds webpack assets.

```shell
$ composer build-production
```

Installs composer dependencies, installs npm dependencies, builds webpack assets and removes dev-dependencies.

```shell
$ composer install-app
```

Runs `composer build` and installs database - creating DB tables and seeding some data.

```shell
$ php install.php [fresh]
```

Installs database - creating DB tables and seeding some data. If argument `fresh` is given, current tables are dropped
and the database is cleared before installing.

```shell
$ composer test
```

Runs unit tests.

```shell
$ composer serve
```

Starts PHP server on port `8000`.

```shell
$ composer docs
```

Generates doxygen API docs.

```shell
$ npm run build
```

Builds webpack assets in production mode.

```shell
$ npm run build-dev
```

Builds webpack assets in development mode.

```shell
$ npm run watch
```

Builds webpack assets. Watches assets changes and auto-builds on save.

#### PHP

All libraries are installed using [**Composer**](https://getcomposer.org).

```shell script
$ composer install
```

#### Front-end

Front-end dependencies are managed by [**npm**](https://www.npmjs.com/get-npm) and [**Webpack**](https://webpack.js.org)
.

[Download npm and Node.js](https://nodejs.org/en/)

Install all npm packages:

```shell script
$ npm install
```

Run webpack (pack all js and css)

```shell script
$ npm run build
```

### Run tests

[**PHPUnit**](https://phpunit.readthedocs.io/en/9.5/) is installed as a developer dependency using [**
Composer**](https://getcomposer.org).

```shell script
$ composer test
```

## Templating

All pages have a defined class in `App\Controllers` namespace containing all logic, and a latte template file containing
all HTML in templates folder.

Custom Latte tags and filters are defined in `config/latte.php`.

@link pages-page Pages creation documentation @endlink

### Translation

There are 3 ways of translating text in latte templates.

#### Function - also available in all PHP code

```latte
{lang('Text to translate')}
```

#### Filter

```latte
{$variableToTranslate|lang}
```

#### Tag

```latte
{lang 'Text to translate'}
```

### Links

There is also a Latte alternative to App::getLink method

```latte
{link ['path', 'to', 'parse', 'param' => 'value']}
```

```latte
{getUrl}
```

Returns a base (root) URL of the site.

### CSRF

Cross-site-scripting protection is implemented using latte helper functions.

```latte
{csrf}
```

Returns a general purpose CSRF token.

```latte
{csrfInput $name}
```

Returns a generated html `input[type=hidden]` containing a CSRF token. `$name` is preferably the name of the form, or
any other identifier.

#### Validating CSRF

```php
isTokenValid($hash);
```

Checks if the given hash is valid.

```php
formValid($name);
```

Checks if hash for sent form exists and is valid.

#### Using CSRFCheck middleware

Middleware can be attached to a Route or Controller on setup. CSRFCheck middleware checks if there is a valid CSRF token
and returns an error otherwise. CSRF form name is equal to route's path.

Example:

```php
// routes/web.php

use \App\Core\Routing\Route;
use \App\Controllers\Test;
use \App\Core\Middleware\CSRFCheck;

Route::get('/test', [Test::class, 'show']);
Route::post('/test', [Test::class, 'send'])->middleware(new CSRFCheck());

```

```php
// src/Controllers/Test.php

namespace \App\Controllers;

use \Lsr\Core\Requests\Request;

class Test extends \Lsr\Core\Controller {
	
	public function show() {
		$this->view('pages/test/index');
	}
	
	public function send(Request $request) {
		// Process form here
		$this->view('pages/test/index');
	}

}
```

```latte
{* templates/pages/test/index.latte *}
{layout '../../@layout.latte'}

{define content}
<form action="{link ['test']}">
	{csrfInput 'test'}

	{* Rest of the form here... *}

	<button type="submit">Send</button>
</form>
{/define}

```
